generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Invoice {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceNumber  String    @unique @map("invoice_number")
  orderId        String?   @map("order_id") @db.Uuid
  userId         String?   @map("user_id") @db.Uuid
  guestName      String?   @map("guest_name")
  guestEmail     String?   @map("guest_email")
  guestWhatsapp  String?   @map("guest_whatsapp")
  guestAddress   String?   @map("guest_address")
  user           User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subtotal       Decimal   @db.Decimal(10, 2)
  tax            Decimal   @default(0) @db.Decimal(10, 2)
  deliveryFee    Decimal   @default(100000) @map("delivery_fee") @db.Decimal(10, 2)
  total          Decimal   @db.Decimal(10, 2)
  status         String    @default("PENDING") // PENDING, PAID, OVERDUE, SENT
  currency       String?   @default("IDR")
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  order          Order?    @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("invoices")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Order {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderNumber    String         @unique @map("order_number")
  userId         String         @map("user_id") @db.Uuid
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  status         String         @default("PENDING")
  startDate      DateTime       @map("start_date") @db.Timestamptz(6)
  endDate        DateTime       @map("end_date") @db.Timestamptz(6)
  duration       Int
  totalAmount    Decimal        @map("total_amount") @db.Decimal(10, 2)
  subtotal       Decimal        @db.Decimal(10, 2)
  tax            Decimal        @default(0) @db.Decimal(10, 2)
  deliveryFee    Decimal        @default(100000) @map("delivery_fee") @db.Decimal(10, 2)
  currency       String?        @default("IDR")
  paymentMethod  String?        @map("payment_method")
  createdAt      DateTime?      @default(now()) @map("created_at") @db.Timestamptz(6)
  invoices       Invoice[]
  rentalItems    RentalItem[]

  @@map("orders")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model RentalPackageItem {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rentalPackageId String        @map("package_id") @db.Uuid
  productId       String        @map("product_id") @db.Uuid
  quantity        Int?          @default(1)
  createdAt       DateTime?     @default(now()) @map("created_at") @db.Timestamptz(6)
  rentalPackage   RentalPackage @relation(fields: [rentalPackageId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product         Product       @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("package_items")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model RentalPackage {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String
  description        String?
  imageUrl           String?             @map("image_url")
  images             String[]            @default([])
  specs              Json?
  price              Decimal             @db.Decimal(10, 2)
  duration           Int
  createdAt          DateTime?           @default(now()) @map("created_at") @db.Timestamptz(6)
  rentalPackageItems RentalPackageItem[]
  rentalItems        RentalItem[]

  @@map("packages")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Product {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String
  description        String?
  category           String
  monthlyPrice       Decimal             @map("monthly_price") @db.Decimal(10, 2)
  stock              Int?                @default(0)
  imageUrl           String?             @map("image_url")
  images             String[]            @default([])
  specs              Json?
  createdAt          DateTime?           @default(now()) @map("created_at") @db.Timestamptz(6)
  productUnits       ProductUnit[]
  rentalPackageItems RentalPackageItem[]
  rentalItems        RentalItem[]

  @@map("products")
}

model ProductUnit {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId    String    @map("product_id") @db.Uuid
  unitCode     String    @unique @map("unit_code")
  status       String    @default("AVAILABLE") // AVAILABLE, IN_USE, DAMAGED
  purchaseDate DateTime  @map("purchase_date") @db.Timestamptz(6)
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_units")
}

model SystemNotification {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type      String    // INFO, WARNING, ERROR
  title     String
  message   String
  isRead    Boolean   @default(false) @map("is_read")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("system_notifications")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model RentalItem {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId       String         @map("order_id") @db.Uuid
  productId     String?        @map("product_id") @db.Uuid
  packageId     String?        @map("package_id") @db.Uuid
  quantity      Int?           @default(1)
  createdAt     DateTime?      @default(now()) @map("created_at") @db.Timestamptz(6)
  order         Order          @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  rentalPackage RentalPackage? @relation(fields: [packageId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product       Product?       @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("rental_items")
}

model User {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username        String    @unique
  password        String
  email           String    @unique
  fullName        String    @map("full_name")
  whatsapp        String
  baliAddress     String?   @map("bali_address")
  mapsAddressLink String?   @map("maps_address_link")
  role            String    @default("USER")
  isActive        Boolean   @default(true) @map("is_active")
  isVerified      Boolean   @default(false) @map("is_verified")
  resetPasswordToken   String?   @map("reset_password_token")
  resetPasswordExpires DateTime? @map("reset_password_expires") @db.Timestamptz(6)
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  orders          Order[]
  invoices        Invoice[]
  activityLogs    ActivityLog[]

  @@map("users")
}

model ActivityLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  user      User?    @relation(fields: [userId], references: [id])
  action    String   
  entity    String   
  details   String?  
  createdAt DateTime @default(now()) @map("created_at")

  @@map("activity_logs")
}
