generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Invoice {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceNumber  String    @unique @map("invoice_number")
  orderId        String?   @map("order_id") @db.Uuid
  userId         String?   @map("user_id") @db.Uuid
  guestName      String?   @map("guest_name")
  guestEmail     String?   @map("guest_email")
  guestWhatsapp  String?   @map("guest_whatsapp")
  guestAddress   String?   @map("guest_address")
  user           User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subtotal       Decimal   @db.Decimal(10, 2)
  tax            Decimal   @default(0) @db.Decimal(10, 2)
  taxRate        Decimal   @default(0.02) @map("tax_rate") @db.Decimal(5, 4)
  deliveryFee    Decimal   @default(100000) @map("delivery_fee") @db.Decimal(10, 2)
  deliveryFeeOverride Decimal? @map("delivery_fee_override") @db.Decimal(10, 2)
  total          Decimal   @db.Decimal(10, 2)
  status         String    @default("PENDING") // PENDING, PAID, OVERDUE, SENT
  currency       String?   @default("IDR")
  shareableToken String?   @unique @map("shareable_token")
  emailSent      Boolean   @default(false) @map("email_sent")
  emailSentAt    DateTime? @map("email_sent_at") @db.Timestamptz(6)
  createdAt      DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  order          Order?    @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("invoices")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Order {
  id             String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderNumber    String         @unique @map("order_number")
  userId         String         @map("user_id") @db.Uuid
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  status         String         @default("PENDING")
  startDate      DateTime       @map("start_date") @db.Timestamptz(6)
  endDate        DateTime       @map("end_date") @db.Timestamptz(6)
  duration       Int
  totalAmount    Decimal        @map("total_amount") @db.Decimal(10, 2)
  subtotal       Decimal        @db.Decimal(10, 2)
  tax            Decimal        @default(0) @db.Decimal(10, 2)
  deliveryFee    Decimal        @default(100000) @map("delivery_fee") @db.Decimal(10, 2)
  currency       String?        @default("IDR")
  paymentMethod  String?        @map("payment_method")
  paymentStatus  String?        @map("payment_status") @default("PENDING")
  paymentConfirmedBy String?    @map("payment_confirmed_by") @db.Uuid
  paymentConfirmedAt DateTime?  @map("payment_confirmed_at") @db.Timestamptz(6)
  deliveryStatus String?        @map("delivery_status") @default("PENDING")
  deliveryAddress String?       @map("delivery_address")
  createdAt      DateTime?      @default(now()) @map("created_at") @db.Timestamptz(6)
  invoices       Invoice[]
  rentalItems    RentalItem[]
  workerSchedules WorkerSchedule[]

  @@map("orders")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model RentalPackageItem {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  rentalPackageId String        @map("package_id") @db.Uuid
  productId       String        @map("product_id") @db.Uuid
  quantity        Int?          @default(1)
  createdAt       DateTime?     @default(now()) @map("created_at") @db.Timestamptz(6)
  rentalPackage   RentalPackage @relation(fields: [rentalPackageId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product         Product       @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("package_items")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model RentalPackage {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String
  description        String?
  imageUrl           String?             @map("image_url")
  images             String[]            @default([])
  specs              Json?
  price              Decimal             @db.Decimal(10, 2)
  duration           Int
  createdAt          DateTime?           @default(now()) @map("created_at") @db.Timestamptz(6)
  rentalPackageItems RentalPackageItem[]
  rentalItems        RentalItem[]

  @@map("packages")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Product {
  id                 String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name               String
  description        String?
  category           String
  monthlyPrice       Decimal             @map("monthly_price") @db.Decimal(10, 2)
  stock              Int?                @default(0)
  imageUrl           String?             @map("image_url")
  images             String[]            @default([])
  specs              Json?
  createdAt          DateTime?           @default(now()) @map("created_at") @db.Timestamptz(6)
  productUnits       ProductUnit[]
  rentalPackageItems RentalPackageItem[]
  rentalItems        RentalItem[]
  inventorySyncLogs  InventorySyncLog[]

  @@map("products")
}

model ProductUnit {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId    String    @map("product_id") @db.Uuid
  unitCode     String    @unique @map("unit_code")
  status       String    @default("AVAILABLE") // AVAILABLE, IN_USE, DAMAGED
  purchaseDate DateTime  @map("purchase_date") @db.Timestamptz(6)
  createdAt    DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_units")
}

model SystemNotification {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type      String    // INFO, WARNING, ERROR
  title     String
  message   String
  isRead    Boolean   @default(false) @map("is_read")
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)

  @@map("system_notifications")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model RentalItem {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId       String         @map("order_id") @db.Uuid
  productId     String?        @map("product_id") @db.Uuid
  packageId     String?        @map("package_id") @db.Uuid
  quantity      Int?           @default(1)
  createdAt     DateTime?      @default(now()) @map("created_at") @db.Timestamptz(6)
  order         Order          @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  rentalPackage RentalPackage? @relation(fields: [packageId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  product       Product?       @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("rental_items")
}

model User {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  username        String    @unique
  password        String
  email           String    @unique
  fullName        String    @map("full_name")
  whatsapp        String
  baliAddress     String?   @map("bali_address")
  mapsAddressLink String?   @map("maps_address_link")
  role            String    @default("USER")
  isActive        Boolean   @default(true) @map("is_active")
  isVerified      Boolean   @default(false) @map("is_verified")
  resetPasswordToken   String?   @map("reset_password_token")
  resetPasswordExpires DateTime? @map("reset_password_expires") @db.Timestamptz(6)
  createdAt       DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  orders          Order[]
  invoices        Invoice[]
  activityLogs    ActivityLog[]
  
  // Worker relations
  workerSchedules WorkerSchedule[] @relation("WorkerSchedules")
  assignedSchedules WorkerSchedule[] @relation("AssignedSchedules")
  workerAttendance WorkerAttendance[]
  inventoryUpdates InventorySyncLog[] @relation("InventoryUpdates")
  inventoryResolutions InventorySyncLog[] @relation("InventoryResolutions")
  receivedNotifications WorkerNotification[] @relation("ReceivedNotifications")
  sentNotifications WorkerNotification[] @relation("SentNotifications")

  @@map("users")
}

model ActivityLog {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  user      User?    @relation(fields: [userId], references: [id])
  action    String   
  entity    String   
  details   String?  
  createdAt DateTime @default(now()) @map("created_at")

  @@map("activity_logs")
}

model WorkerSchedule {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workerId     String   @map("worker_id") @db.Uuid
  orderId      String   @map("order_id") @db.Uuid
  assignedBy   String   @map("assigned_by") @db.Uuid
  assignedAt   DateTime @default(now()) @map("assigned_at") @db.Timestamptz(6)
  status       String   @default("PENDING") // PENDING, ONGOING, FINISHED, DELAYED, CANCELLED
  scheduledDate DateTime @map("scheduled_date") @db.Date
  notes        String?
  workerNotes  String?  @map("worker_notes")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)
  
  worker       User     @relation("WorkerSchedules", fields: [workerId], references: [id], onDelete: Cascade)
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  assignedByUser User   @relation("AssignedSchedules", fields: [assignedBy], references: [id])

  @@map("worker_schedules")
}

model WorkerAttendance {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workerId     String    @map("worker_id") @db.Uuid
  date         DateTime  @db.Date
  status       String    @default("PRESENT") // PRESENT, ABSENT, LATE, LEAVE
  checkInTime  DateTime? @map("check_in_time") @db.Timestamptz(6)
  checkOutTime DateTime? @map("check_out_time") @db.Timestamptz(6)
  notes        String?
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  
  worker       User      @relation(fields: [workerId], references: [id], onDelete: Cascade)

  @@unique([workerId, date])
  @@map("worker_attendance")
}

model InventorySyncLog {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId   String    @map("product_id") @db.Uuid
  oldQuantity Int       @map("old_quantity")
  newQuantity Int       @map("new_quantity")
  updatedBy   String    @map("updated_by") @db.Uuid
  source      String    // ADMIN, WORKER
  conflict    Boolean   @default(false)
  resolved    Boolean   @default(false)
  resolvedBy  String?   @map("resolved_by") @db.Uuid
  resolvedAt  DateTime? @map("resolved_at") @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  updatedByUser User    @relation("InventoryUpdates", fields: [updatedBy], references: [id])
  resolvedByUser User?  @relation("InventoryResolutions", fields: [resolvedBy], references: [id])

  @@map("inventory_sync_logs")
}

model WorkerNotification {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workerId    String    @map("worker_id") @db.Uuid
  fromAdminId String?   @map("from_admin_id") @db.Uuid
  type        String    // JOB_ASSIGNED, INVENTORY_CONFLICT, ADMIN_MESSAGE, etc.
  title       String
  message     String
  isRead      Boolean   @default(false) @map("is_read")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  
  worker      User      @relation("ReceivedNotifications", fields: [workerId], references: [id], onDelete: Cascade)
  fromAdmin   User?     @relation("SentNotifications", fields: [fromAdminId], references: [id])

  @@map("worker_notifications")
}
